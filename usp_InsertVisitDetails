CREATE PROCEDURE [dbo].[usp_InsertVisitDetails](
      @RequestID int
      ,@Date  varchar(100),
       @Status varchar(100))
              
AS
BEGIN
       -- SET NOCOUNT ON added to prevent extra result sets from
       -- interfering with SELECT statements.
       SET NOCOUNT ON;

    -- Insert statements for procedure here

	   Declare @Status1 varchar(10)=(select LEFT(@Status,6))
		Declare @VisitID varchar(10)=(SELECT SUBSTRING(@Status,CHARINDEX('~',@Status)+1,LEN(@Status)))
       if(@Status1='update')
       begin
       --Delete [VisitDetails] where RequestID=@RequestID
       declare @Count int=(select top 1 VisitDetailsID from [VisitDetails] where VisitDetailsID=@VisitID order by 1 desc)
       if(@Count is null OR @Count=0)
       begin
       insert into [VisitDetails](RequestID,Date) values(@RequestID,@Date)
       select SCOPE_IDENTITY() as ID
       end
       else
       begin
       Update [VisitDetails] set Date=@Date where RequestID=@RequestID and VisitDetailsID=@Count
       select VisitDetailsID as ID from [VisitDetails] where RequestID=@RequestID 
       end
       end
       else
       begin
       insert into [VisitDetails] (RequestID,Date) values(@RequestID,@Date)
       select SCOPE_IDENTITY() as ID
       end
       
END 
