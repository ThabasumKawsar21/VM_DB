

CREATE PROCEDURE [dbo].[GetVisitorCardInfo]
@visitdetailsID varchar(50)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
BEGIN TRY

BEGIN TRAN
DECLARE @ErrorMessage VARCHAR(8000);
DECLARE @ErrorSeverity INT;
DECLARE @ErrorState INT;

    Select BadgeNo,BadgeStatus,BadgeIssuedDate,CONVERT(CHAR(10), date, 103) as Date from VisitDetails where RequestID in(Select TOP 1 RequestID from VisitDetails where VisitDetailsID=@visitdetailsID) and BadgeStatus !='Returned'
	UNION
	Select BadgeNo,BadgeStatus,BadgeIssuedDate,CONVERT(CHAR(10), date, 103) as Date from ReissuedCardDetails where RequestID in(Select TOP 1 RequestID from ReissuedCardDetails where VisitDetailsID=@visitdetailsID) and BadgeStatus !='Returned'
COMMIT TRAN
END TRY

BEGIN CATCH
ROLLBACK TRAN
IF (@@ERROR <> 0)
BEGIN	
SELECT
@ErrorMessage =ERROR_MESSAGE(),
@ErrorSeverity = ERROR_SEVERITY(),
@ErrorState = ERROR_STATE();
RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END
END CATCH	

END
