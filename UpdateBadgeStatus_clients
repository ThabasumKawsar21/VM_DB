CREATE PROCEDURE [dbo].[UpdateBadgeStatus_clients]
(
@bdgestatus varchar(100),
@visitorid int,
@reqstatus varchar(50),
@VisDetailsID int,
@comments varchar(500),
@ModifiedBy varchar(50),
@reportedfacility varchar(50),
@reportedby int,
@reportedon datetime
)
AS
BEGIN 
	SET NOCOUNT ON;
	Declare @OutTime varchar(20);
	set @OutTime= convert(datetime,getDate(),108); 
	DECLARE @ReqID INT
	--set @ReqID = (select top(1) RequestID from VisitDetails WITH (NOLOCK) where VisitDetailsID = @VisDetailsID)

	DECLARE @loston datetime;
	if @reportedon is null
	begin
  set @loston = getdate()
	end
	else
	begin
	set @loston = @reportedon
	end

	DECLARE @accesscardnumber int;


SET @accesscardnumber = (select TOP 1 accesscardnumber from  Clientrequestdetails where VisitorID=@visitorid and ParentRefernceId=@VisDetailsID and 
RequestID in (select RequestID from VisitorRequest where VisitorID=@visitorid and ParentReferenceId=@VisDetailsID) order by clientrequestdetailid desc)

	Update VisitDetails set BadgeStatus=@bdgestatus, ActualOutTime=@OutTime 
	--where VisitDetailsID=@VisDetailsID
	--where RequestID in (select requestid from visitorrequest where parentreferenceid=@VisDetailsID)
	where RequestID in (select RequestID from VisitorRequest where VisitorID=@visitorid and ParentReferenceId=@VisDetailsID)



	Update VisitorRequest set RequestStatus=@reqstatus, LastUpdatedby=@ModifiedBy, LastUpdatedDate=GETDATE() 
	--where RequestID=@ReqID 
	--WHERE ParentReferenceId = @VisDetailsID
	where RequestID in (select RequestID from VisitorRequest where VisitorID=@visitorid and ParentReferenceId=@VisDetailsID)


	update ClientRequestDetails SET ReportedFacility= @reportedfacility ,ReportedOn=@loston,ReportedBy=@reportedby where RequestID in (select RequestID from VisitorRequest where VisitorID=@visitorid and ParentReferenceId=@VisDetailsID) 
	and VisitorID=@visitorid and ParentRefernceId=@VisDetailsID and AccessCardNumber=@accesscardnumber
END
